"use strict";_coreJs.Object.defineProperty(exports,"__esModule",{value:!0}),exports.controlFreePanel=exports.createFreePanel=void 0;var _coreJs=require("core-js"),_mainPanel=require("./mainPanel.vue"),_mainPanel2=_interopRequireDefault(_mainPanel);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,o,n){return o in e?_coreJs.Object.defineProperty(e,o,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[o]=n,e}function transit(){var o=this,n=this;this.thisContainer={},this.defaultFreeStyle={},this.defaultFreeData={},this.defaultFreeConfig={},this.componentsName=[],this.currentControlId="",this.currentSwitchCallback={},this.currentChangeCallback={},this.groupChangeCallback={},this.modifyRecord=[],this.currentRecordIndex=-1,this.triggerLock=!0,this.groupBarrel={},this.groupState=!1,this.groupTemporaryContainer=null,this.thisHook=function(e,o){n.thisContainer[e]||(n.thisContainer[e]=o)},this.useThis=function(e){return n.thisContainer[e]},this.removeThis=function(e){try{n.thisContainer[e]&&delete n.thisContainer[e]}catch(e){console.error(e)}},this.addDefaultFreeConfig=function(e,o){o.props&&(o.props.freeStyle&&o.props.freeStyle.default&&!n.defaultFreeStyle[e]&&(n.defaultFreeStyle[e]=o.props.freeStyle.default()),o.props.freeData&&o.props.freeData.default&&!n.defaultFreeData[e]&&(n.defaultFreeData[e]=o.props.freeData.default()),o.props.freeConfig&&o.props.freeConfig.default&&!n.defaultFreeConfig[e]&&(n.defaultFreeConfig[e]=o.props.freeConfig.default()))},this.reset=function(e){o.thisContainer.mainPanel&&_coreJs.Object.assign(o.thisContainer.mainPanel.$data,o.thisContainer.mainPanel.$options.data()),o.currentControlId="",o.modifyRecord=[],o.currentRecordIndex=-1,o.groupBarrel={},o.groupState=!1,o.groupTemporaryContainer=null,e&&(o.currentSwitchCallback={},o.currentChangeCallback={})}}var createFreePanel=exports.createFreePanel=function(){var o=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=new transit;this.freeTransit=t,this.mainPanel=_mainPanel2.default;function n(e,o){var n;o.created?(n=o.created,o.created=function(){t.thisHook(e||this.id,this),n.call(this)}):o.created=function(){t.thisHook(e||this.id,this)},o.beforeDestroy&&o.beforeDestroy.length||(o.beforeDestroy=[]),o.beforeDestroy[o.beforeDestroy.length]=function(){t.removeThis(e||this.id,this)}}n("mainPanel",this.mainPanel),t.addDefaultFreeConfig("mainPanel",this.mainPanel),e.components&&e.components.length&&e.components.map(function(e){return n(void 0,e.component),t.addDefaultFreeConfig(e.name,e.component),t.componentsName.push(e.name),e.component.props||(e.component.props={}),e.component.props.id={type:null},e.component.props.positioning={type:null},o.mainPanel.components||(o.mainPanel.components={}),o.mainPanel.components[e.name]=e.component,e}),this.component=function(){return new Promise(function(e){e(o.mainPanel)})}},controlFreePanel=exports.controlFreePanel=function(k){var a=this;function i(e){try{_coreJs.Object.keys(k.groupBarrel).forEach(function(o){~_coreJs.Object.keys(k.groupBarrel[o].gather).indexOf(e||k.currentControlId)&&_coreJs.Object.keys(k.groupChangeCallback).forEach(function(e){throw k.groupChangeCallback[e](k.groupBarrel[o],k.groupBarrel,k.groupTemporaryContainer),new Error(!0)})}),_coreJs.Object.keys(k.groupChangeCallback).forEach(function(e){k.groupChangeCallback[e](void 0,k.groupBarrel,k.groupTemporaryContainer)})}catch(e){"true"!==e.message&&!0!==e.message&&console.error(e)}}function c(e,o){var n,t,r=1<arguments.length&&void 0!==o?o:16,i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),a=[],r=r||i.length;if(e)for(n=0;n<e;n++)a[n]=i[0|Math.random()*r];else for(a[8]=a[13]=a[18]=a[23]="-",a[14]="4",n=0;n<32;n++)a[n]||(t=0|16*Math.random(),a[n]=i[19==n?3&t|8:t]);return a.join("")}function n(o,n,t,r){if(k.currentControlId&&k.triggerLock){k.triggerLock=!1;var e=k.useThis("mainPanel");try{"mainPanel"===k.currentControlId?e[o][n]=t:e.componentList.forEach(function(e){if(e.id===k.currentControlId){if(!("positioning"==o?~["left","top","zIndex"].indexOf(n)&&e.positioning:~_coreJs.Object.keys(k["freeStyle"==o?"defaultFreeStyle":"freeData"==o?"defaultFreeData":"freeConfig"==o?"defaultFreeConfig":""][e.name]).indexOf(n)))throw new Error("修改的配置属性不在修改范围！");throw r&&L({id:e.id,name:e.name,behavior:"updata",type:o,key:n,newData:_defineProperty({},o,_defineProperty({},n,t)),oldData:_defineProperty({},o,_defineProperty({},n,e[o][n]))}),e[o]=_coreJs.Object.assign({},e[o],_defineProperty({},n,t)),new Error(!0)}})}catch(e){"true"!==e.message&&!0!==e.message&&console.error(e)}e.$nextTick(function(){k.triggerLock=!0})}}function L(e){k.modifyRecord[k.currentRecordIndex+1]&&k.modifyRecord.splice(k.currentRecordIndex+1,k.modifyRecord.length-1);var o=JSON.parse(JSON.stringify(e));k.modifyRecord.push(o),k.currentRecordIndex++,_coreJs.Object.keys(k.currentChangeCallback).forEach(function(e){k.currentChangeCallback[e](o,k.currentRecordIndex,k.modifyRecord)})}function e(e){if(k.triggerLock){k.triggerLock=!1;var n=k.useThis("mainPanel"),t=k.modifyRecord[k.currentRecordIndex],r="rollBack"==e?"oldData":"nextStep"==e?"newData":"";try{t&&(k.currentControlId="",_coreJs.Object.keys(k.currentSwitchCallback).forEach(function(e){k.currentSwitchCallback[e](null)}),"add"==t.behavior&&t[r]||"del"==t.behavior&&t[r]?(n.componentList.push(t[r]),t[r].positioning&&n.$nextTick(function(){k.currentControlId=t.id,_coreJs.Object.keys(k.currentSwitchCallback).forEach(function(e){k.currentSwitchCallback[e](k.useThis(t.id)||null)}),i(),l(t.id),null!=t[r].freeStyle.width&&null!=t[r].freeStyle.height&&(s(t.id,"topRightAngle"),s(t.id,"topLeftAngle"),s(t.id,"bottomRightAngle"),s(t.id,"bottomLeftAngle"))})):"groupMobile"==t.type?n.componentList.forEach(function(e,o){~t.id.indexOf(e.id)&&(n.componentList[o].positioning=t[r].positioning[e.id])}):n.componentList.forEach(function(e,o){if(e.id===t.id)throw"add"==t.behavior||"del"==t.behavior?(n.componentList.splice(o,1),k.removeThis(e.id)):"updata"==t.behavior&&("dragAndDrop"==t.type?n.componentList[o].positioning=t[r].positioning:"mouseZoom"==t.type?(n.componentList[o].freeStyle=t[r].freeStyle,n.componentList[o].positioning=t[r].positioning):n.componentList[o][t.type][t.key]=t[r][t.type][t.key],n.$nextTick(function(){k.currentControlId=t.id,_coreJs.Object.keys(k.currentSwitchCallback).forEach(function(e){k.currentSwitchCallback[e](k.useThis(t.id)||null)}),i()})),new Error(!0)}))}catch(e){"true"!==e.message&&!0!==e.message&&console.error(e)}n.$nextTick(function(){k.triggerLock=!0})}}function l(t){var r,i,a,c,l,s=k.useThis("mainPanel"),e=s.$refs[t][0],u=0,p=0,g={},f={},h=0,d=0,m=!1,C=!1;function o(e){var o,n;e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,m&&(d=h=p=u=0,m=!1,document.onmouseup=null,window.onmousemove=null,C&&(C=!1,l?(e=_coreJs.Object.keys(a),o={positioning:{}},n={positioning:{}},c.map(function(e){o.positioning[s.componentList[e].id]=s.componentList[e].positioning}),e.map(function(e){n.positioning[a[e].id]=a[e].positioning}),L({id:e,behavior:"updata",type:"groupMobile",newData:o,oldData:n})):L({id:r.id,name:r.name,behavior:"updata",type:"dragAndDrop",newData:{positioning:s.componentList[i].positioning},oldData:{positioning:r.positioning}}),l=c=a=i=r=null,g={},d=h=p=u=0,C=m=!(f={})))}function n(e){var t,r,o;e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,0!=m&&(t=e.clientX,r=e.clientY,l?c.forEach(function(e){var o=t-(h-g[e]),n=r-(d-f[e]);s.componentList[e].positioning.left=o+"px",s.componentList[e].positioning.top=n+"px"}):(o=t-(h-u),e=r-(d-p),s.componentList[i].positioning.left=o+"px",s.componentList[i].positioning.top=e+"px"),C=!0)}e.onmousedown=function(e){if(k.groupState)return;e.stopPropagation?e.stopPropagation():e.cancelBubble=!0;try{throw s.componentList.forEach(function(o,e){if(o.id===t){if(o.groupMember)if(k.groupBarrel[o.groupId]){l=!0;var n=_coreJs.Object.keys(k.groupBarrel[o.groupId].gather).map(function(e){return k.groupBarrel[o.groupId].gather[e].id});try{a={},c=[],s.componentList.forEach(function(e,o){~n.indexOf(e.id)&&(a[e.id]=JSON.parse(JSON.stringify(e)),g[o]=Number(e.positioning.left.replace(/px/,"")),f[o]=Number(e.positioning.top.replace(/px/,"")),c.push(o))})}catch(e){console.error(e)}}else delete s.componentList[e].groupMember,delete s.componentList[e].groupId,l=!1,r=JSON.parse(JSON.stringify(o)),i=e,u=Number(o.positioning.left.replace(/px/,"")),p=Number(o.positioning.top.replace(/px/,""));else l=!1,r=JSON.parse(JSON.stringify(o)),i=e,u=Number(o.positioning.left.replace(/px/,"")),p=Number(o.positioning.top.replace(/px/,""));throw new Error(!0)}}),new Error("未找到需要注册拖拽事件的节点")}catch(e){if("true"!==e.message&&!0!==e.message)return void console.error(e)}h=e.clientX,d=e.clientY,m=!0,document.onmouseup=o,window.onmousemove=n}}function s(n,t){var r,i,a,c=k.useThis("mainPanel"),o=c.$refs[n][0],e=c.$refs[t+"_"+n][0],l=0,s=0,u=0,p=0,g=null,f=null,h=!1,d=!1;function m(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,h&&(s=l=p=u=0,f=g=null,h=!1,document.onmouseup=null,window.onmousemove=null,d&&(d=!1,L({id:r.id,name:r.name,behavior:"updata",type:"mouseZoom",newData:{positioning:c.componentList[i].positioning,freeStyle:c.componentList[i].freeStyle},oldData:{positioning:r.positioning,freeStyle:r.freeStyle}})))}function C(e){var o,n;e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,0!=h&&(null==g&&(g=e.clientX),null==f&&(f=e.clientY),o=e.clientX-g,n=e.clientY-f,e=JSON.parse(JSON.stringify(c.componentList[i].freeStyle)),"topLeftAngle"==t?(e.width&&(e.width=y(-1*o+l,function(){a&&(c.componentList[i].positioning.left=o+u+"px")})+"px"),e.height&&(e.height=b(-1*n+s,function(){a&&(c.componentList[i].positioning.top=n+p+"px")})+"px")):"bottomLeftAngle"==t?(e.width&&(e.width=y(-1*o+l,function(){a&&(c.componentList[i].positioning.left=o+u+"px")})+"px"),e.height&&(e.height=b(n+s)+"px")):"topRightAngle"==t?(e.width&&(e.width=y(o+l)+"px"),e.height&&(e.height=b(-1*n+s,function(){a&&(c.componentList[i].positioning.top=n+p+"px")})+"px")):"bottomRightAngle"==t&&(e.width&&(e.width=y(o+l)+"px"),e.height&&(e.height=b(n+s)+"px")),c.componentList[i].freeStyle=e,d=!0)}function y(e,o){return 10<e?(o&&o(),e):10}function b(e,o){return 10<e?(o&&o(),e):10}e.onmousedown=function(e){if(k.groupState)return;e.stopPropagation?e.stopPropagation():e.cancelBubble=!0;try{throw c.componentList.forEach(function(e,o){if(e.id===n)throw r=JSON.parse(JSON.stringify(e)),i=o,a=!!e.positioning,new Error(!0)}),new Error("未找到需要注册拖拽事件的节点")}catch(e){if("true"!==e.message&&!0!==e.message)return void console.error(e)}l=o.offsetWidth,s=o.offsetHeight,u=o.offsetLeft,p=o.offsetTop,h=!0,document.onmouseup=m,window.onmousemove=C}}this.setCurrentControl=function(o){k.groupState?function(e){for(var o=k.useThis("mainPanel"),n=0;n<o.componentList.length;n++)if(e==o.componentList[n].id){if(o.componentList[n].groupMember)if(o.componentList[n].groupId==k.groupTemporaryContainer.groupId)delete o.componentList[n].groupMember,delete o.componentList[n].groupId,delete k.groupTemporaryContainer.gather[e];else try{throw new Error("该组件已经加入其他分组，一个组件只能加入一个分组")}catch(e){console.log(e)}else o.componentList[n].groupMember=!0,o.componentList[n].groupId=k.groupTemporaryContainer.groupId,k.groupTemporaryContainer.gather[e]={id:o.componentList[n].id,name:o.componentList[n].name};break}_coreJs.Object.keys(k.groupChangeCallback).forEach(function(e){k.groupChangeCallback[e](k.groupBarrel[k.groupTemporaryContainer.groupId],k.groupBarrel,k.groupTemporaryContainer)})}(o):k.triggerLock&&(k.triggerLock=!1,k.currentControlId!==o&&(k.currentControlId=o,_coreJs.Object.keys(k.currentSwitchCallback).forEach(function(e){k.currentSwitchCallback[e](o&&k.useThis(o)||null)})),i(),k.useThis("mainPanel").$nextTick(function(){k.triggerLock=!0}))},this.listeningCurrentSwitch=function(e){var o=c();return k.currentSwitchCallback[o]=e,function(){delete k.currentSwitchCallback[o]}},this.listeningCurrentChange=function(e){var o=c();return k.currentChangeCallback[o]=e,function(){delete k.currentChangeCallback[o]}},this.addComponent=function(e,o,n){if(~k.componentsName.indexOf(e)){var t=k.useThis("mainPanel");if(t.componentList&&k.triggerLock){k.triggerLock=!1;var r=c(),i=n||{id:r,name:e,freeStyle:k.defaultFreeStyle[e]||{},freeData:k.defaultFreeData[e]||{},freeConfig:k.defaultFreeConfig[e]||{}};o&&_coreJs.Object.assign(i,{positioning:{position:"absolute",left:"0px",top:(t.scrollTop||0)+"px",zIndex:1}}),t.componentList.push(i),L({id:r,name:e,behavior:"add",newData:i,oldData:null}),t.$nextTick(function(){a.setCurrentControl(r),o&&l(r),o&&null!=i.freeStyle.width&&null!=i.freeStyle.height&&(s(r,"topRightAngle"),s(r,"topLeftAngle"),s(r,"bottomRightAngle"),s(r,"bottomLeftAngle")),k.triggerLock=!0})}else try{throw new Error("页面组件没有componentList组件容器！")}catch(e){console.error(e)}}else try{throw new Error(e+":组件不存在！")}catch(e){console.error(e)}},this.removeComponent=function(n){if((n||k.currentControlId)&&k.triggerLock){k.triggerLock=!1;var t=k.useThis("mainPanel");try{t.componentList&&t.componentList.forEach(function(e,o){if(e.id==(n||k.currentControlId)){k.removeThis(k.currentControlId);o=t.componentList.splice(o,1);throw L({id:o[0].id,name:o[0].name,behavior:"del",newData:null,oldData:o[0]}),new Error(!0)}})}catch(e){"true"!==e.message&&!0!==e.message&&console.error(e)}t.$nextTick(function(){k.triggerLock=!0,a.setCurrentControl("")})}},this.setStyle=function(e,o){n("freeStyle",e,o,!(2<arguments.length&&void 0!==arguments[2])||arguments[2])},this.setData=function(e,o){n("freeData",e,o,!(2<arguments.length&&void 0!==arguments[2])||arguments[2])},this.setConfig=function(e,o){n("freeConfig",e,o,!(2<arguments.length&&void 0!==arguments[2])||arguments[2])},this.setPositioning=function(e,o){n("positioning",e,o,!(2<arguments.length&&void 0!==arguments[2])||arguments[2])},this.echoComponent=function(e){console.log(e),a.resetFreePanel();var o=k.useThis("mainPanel"),n=e.elements;if(k.groupBarrel=e.groupBarrel,o.componentList&&k.triggerLock)try{k.triggerLock=!1,o.componentList=[],_coreJs.Object.keys(k.thisContainer).forEach(function(e){"mainPanel"!==e&&k.removeThis(e)}),o.$nextTick(function(){o.componentList=n,o.$nextTick(function(){o.componentList.forEach(function(e){e.positioning&&l(e.id),e.positioning&&null!=e.freeStyle.width&&null!=e.freeStyle.height&&(s(e.id,"topRightAngle"),s(e.id,"topLeftAngle"),s(e.id,"bottomRightAngle"),s(e.id,"bottomLeftAngle"))}),k.triggerLock=!0})})}catch(e){k.triggerLock=!0}else try{throw new Error("页面组件没有componentList组件容器！")}catch(e){console.error(e)}},this.createGroup=function(){var o=k.useThis("mainPanel");k.currentControlId="",_coreJs.Object.keys(k.currentSwitchCallback).forEach(function(e){k.currentSwitchCallback[e](null)}),o.$nextTick(function(){k.groupState=!0,o.groupState=!0;var e=c();k.groupTemporaryContainer={groupId:e,name:"newGroup",gather:{}},k.groupBarrel[e]=k.groupTemporaryContainer,_coreJs.Object.keys(k.groupChangeCallback).forEach(function(e){k.groupChangeCallback[e](k.groupTemporaryContainer,k.groupBarrel,k.groupTemporaryContainer)})})},this.setGroup=function(e){var o=k.useThis("mainPanel"),e=k.groupBarrel[e];e&&(k.groupState=!0,o.groupState=!0,k.groupTemporaryContainer=e)},this.getGroup=function(e){if(k.groupBarrel[e])return k.groupBarrel[e]},this.setGroupName=function(o,e){k.groupBarrel[o]&&void 0!==e&&(k.groupBarrel[o].name=e),_coreJs.Object.keys(k.groupChangeCallback).forEach(function(e){k.groupChangeCallback[e](k.groupBarrel[o],k.groupBarrel,k.groupTemporaryContainer)})},this.delGroup=function(e){for(var o=k.useThis("mainPanel"),n=_coreJs.Object.keys(k.groupBarrel[e].gather),t=0;t<o.componentList.length;t++)~n.indexOf(o.componentList[t].id)&&(delete o.componentList[t].groupMember,delete o.componentList[t].groupId);delete k.groupBarrel[e],_coreJs.Object.keys(k.groupChangeCallback).forEach(function(e){k.groupChangeCallback[e](void 0,k.groupBarrel,k.groupTemporaryContainer)})},this.determineGroup=function(){var o;1==k.groupState&&(o=k.groupTemporaryContainer.groupId,k.groupBarrel[o]=k.groupTemporaryContainer,a.closeGroup()),_coreJs.Object.keys(k.groupChangeCallback).forEach(function(e){k.groupChangeCallback[e](k.groupBarrel[o],k.groupBarrel,k.groupTemporaryContainer)})},this.closeGroup=function(){var e=k.useThis("mainPanel");k.groupState=!1,e.groupState=!1,k.groupTemporaryContainer=null},this.listeningGroupChange=function(e){var o=c();return k.groupChangeCallback[o]=e,function(){delete k.groupChangeCallback[o]}},this.rollBack=function(){0<=k.currentRecordIndex&&(e("rollBack"),k.currentRecordIndex--)},this.nextStep=function(){k.currentRecordIndex+1<k.modifyRecord.length&&(k.currentRecordIndex++,e("nextStep"))},this.savePhaseData=function(){k.modifyRecord=[],k.currentRecordIndex=-1;var e=k.useThis("mainPanel");try{return{groupBarrel:k.groupBarrel,elements:e.componentList}}catch(e){console.error(e)}finally{_coreJs.Object.keys(k.currentChangeCallback).forEach(function(e){k.currentChangeCallback[e](null,k.currentRecordIndex,k.modifyRecord)})}},this.resetFreePanel=function(e){k.reset(e),_coreJs.Object.keys(k.currentSwitchCallback).forEach(function(e){k.currentSwitchCallback[e](null)}),_coreJs.Object.keys(k.currentChangeCallback).forEach(function(e){k.currentChangeCallback[e](null,k.currentRecordIndex,k.modifyRecord)})}};